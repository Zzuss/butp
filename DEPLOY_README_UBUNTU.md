# Ubuntuç”¨æˆ·ç‰ˆCASä»£ç†æœåŠ¡éƒ¨ç½²æŒ‡å—

## ğŸ¯ é€‚ç”¨ç¯å¢ƒ

- **ç³»ç»Ÿ**: Ubuntu/Debian
- **æƒé™**: æ™®é€šç”¨æˆ·ï¼ˆæ— éœ€rootæƒé™ï¼‰
- **ç”¨æˆ·**: bupt
- **ç«¯å£**: 8080

## ğŸš€ ä¸€é”®éƒ¨ç½²

### 1. ä¸‹è½½å¹¶è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
# ç¡®ä¿ä»¥buptç”¨æˆ·èº«ä»½è¿è¡Œ
whoami  # åº”è¯¥æ˜¾ç¤º: bupt

# è¿è¡Œéƒ¨ç½²è„šæœ¬
bash deploy-cas-proxy.sh
```

### 2. éƒ¨ç½²è¿‡ç¨‹

è„šæœ¬å°†è‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. âœ… æ£€æµ‹ç³»ç»Ÿç¯å¢ƒï¼ˆUbuntuï¼‰
2. âœ… éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆbuptï¼‰
3. âœ… å®‰è£…Node.jsï¼ˆé€šè¿‡nvmï¼‰
4. âœ… åˆ›å»ºé¡¹ç›®ç›®å½•ï¼ˆ~/cas-proxyï¼‰
5. âœ… åˆå§‹åŒ–Node.jsé¡¹ç›®
6. âœ… åˆ›å»ºä»£ç†æœåŠ¡å™¨ä»£ç 
7. âœ… å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
8. âœ… é…ç½®å¹¶å¯åŠ¨æœåŠ¡
9. âœ… åˆ›å»ºç®¡ç†è„šæœ¬

### 3. éƒ¨ç½²å®Œæˆ

éƒ¨ç½²æˆåŠŸåä¼šæ˜¾ç¤ºï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     éƒ¨ç½²å®Œæˆ                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  æœåŠ¡åç§°: cas-proxy                                         â•‘
â•‘  æœåŠ¡åœ°å€: http://10.3.58.3:8080                            â•‘
â•‘  å›è°ƒåœ°å€: http://10.3.58.3:8080/api/auth/cas/callback      â•‘
â•‘  ç›®æ ‡åŸŸå: https://butp.tech                                 â•‘
â•‘  é¡¹ç›®ç›®å½•: /home/bupt/cas-proxy                              â•‘
â•‘  è¿è¡Œç”¨æˆ·: bupt                                              â•‘
â•‘  è¿›ç¨‹ç®¡ç†: PM2                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ”§ æœåŠ¡ç®¡ç†

### ä½¿ç”¨ä¾¿æ·è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./cas-proxy-ctl.sh status

# é‡å¯æœåŠ¡
./cas-proxy-ctl.sh restart

# æŸ¥çœ‹æ—¥å¿—
./cas-proxy-ctl.sh logs

# å¥åº·æ£€æŸ¥
./cas-proxy-ctl.sh health

# åœæ­¢æœåŠ¡
./cas-proxy-ctl.sh stop

# å¯åŠ¨æœåŠ¡
./cas-proxy-ctl.sh start
```

### ä½¿ç”¨PM2å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰PM2è¿›ç¨‹
pm2 list

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status cas-proxy

# é‡å¯æœåŠ¡
pm2 restart cas-proxy

# æŸ¥çœ‹æ—¥å¿—
pm2 logs cas-proxy

# åœæ­¢æœåŠ¡
pm2 stop cas-proxy

# å¯åŠ¨æœåŠ¡
pm2 start cas-proxy

# åˆ é™¤æœåŠ¡
pm2 delete cas-proxy

# å®æ—¶ç›‘æ§
pm2 monit
```

## ğŸ“ ç›®å½•ç»“æ„

```
/home/bupt/
â”œâ”€â”€ cas-proxy/                    # ä¸»é¡¹ç›®ç›®å½•
â”‚   â”œâ”€â”€ server.js                 # ä»£ç†æœåŠ¡å™¨ä»£ç 
â”‚   â”œâ”€â”€ package.json              # Node.jsé¡¹ç›®é…ç½®
â”‚   â”œâ”€â”€ ecosystem.config.js       # PM2é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ cas-proxy-ctl.sh          # ç®¡ç†è„šæœ¬
â”‚   â”œâ”€â”€ logs/                     # æ—¥å¿—ç›®å½•
â”‚   â”‚   â”œâ”€â”€ combined.log          # ç»¼åˆæ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ out.log               # è¾“å‡ºæ—¥å¿—
â”‚   â”‚   â””â”€â”€ error.log             # é”™è¯¯æ—¥å¿—
â”‚   â””â”€â”€ node_modules/             # ä¾èµ–åŒ…
â””â”€â”€ cas-proxy-ctl.sh              # ç®¡ç†è„šæœ¬å¿«æ·é“¾æ¥
```

## ğŸ” æµ‹è¯•éªŒè¯

### 1. å¥åº·æ£€æŸ¥

```bash
curl http://10.3.58.3:8080/health
```

æœŸæœ›è¿”å›ï¼š
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "service": "CAS Proxy Server",
  "version": "1.0.0"
}
```

### 2. å›è°ƒæµ‹è¯•

```bash
curl -I "http://10.3.58.3:8080/api/auth/cas/callback?ticket=test"
```

æœŸæœ›è¿”å›302é‡å®šå‘åˆ°butp.techã€‚

### 3. æ ¹è·¯å¾„ä¿¡æ¯

```bash
curl http://10.3.58.3:8080/
```

ä¼šè¿”å›æœåŠ¡åŸºæœ¬ä¿¡æ¯ã€‚

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: Node.jså®‰è£…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ‰‹åŠ¨å®‰è£…nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash

# é‡æ–°åŠ è½½shell
source ~/.bashrc

# å®‰è£…Node.js
nvm install --lts
nvm use --lts
```

### é—®é¢˜2: ç«¯å£è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tulpn | grep :8080

# åœæ­¢å ç”¨è¿›ç¨‹
kill -9 <PID>
```

### é—®é¢˜3: PM2å¯åŠ¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥PM2çŠ¶æ€
pm2 list

# æ¸…é™¤PM2è¿›ç¨‹
pm2 kill

# é‡æ–°å¯åŠ¨
pm2 start ~/cas-proxy/ecosystem.config.js
```

### é—®é¢˜4: æƒé™é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la ~/cas-proxy/

# ä¿®å¤æƒé™
chmod +x ~/cas-proxy/server.js
chmod +x ~/cas-proxy/cas-proxy-ctl.sh
```

## ğŸ”¥ é˜²ç«å¢™é…ç½®

**æ³¨æ„**: æ™®é€šç”¨æˆ·æ— æ³•é…ç½®é˜²ç«å¢™ï¼Œéœ€è¦ç³»ç»Ÿç®¡ç†å‘˜ååŠ©ï¼š

```bash
# è¯·ç³»ç»Ÿç®¡ç†å‘˜æ‰§è¡Œ
sudo ufw allow 8080/tcp

# æˆ–ä½¿ç”¨iptables
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹ç³»ç»Ÿèµ„æº

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹CPUä½¿ç”¨
top
```

### æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f ~/cas-proxy/logs/combined.log

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
tail -n 100 ~/cas-proxy/logs/combined.log

# æœç´¢é”™è¯¯æ—¥å¿—
grep "ERROR" ~/cas-proxy/logs/error.log
```

### å¼€æœºè‡ªå¯è®¾ç½®

```bash
# ç”Ÿæˆå¯åŠ¨è„šæœ¬ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™æ‰§è¡Œç”Ÿæˆçš„å‘½ä»¤ï¼‰
pm2 startup

# ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save
```

## ğŸ‰ éƒ¨ç½²æˆåŠŸ

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼ŒCASä»£ç†æœåŠ¡å·²æˆåŠŸéƒ¨ç½²å¹¶è¿è¡Œåœ¨ `http://10.3.58.3:8080`ï¼

å¯ä»¥é…åˆæ‚¨çš„Next.jsåº”ç”¨ (`butp.tech`) ä½¿ç”¨äº†ã€‚ 
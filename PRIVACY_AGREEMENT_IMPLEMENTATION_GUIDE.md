# 隐私条款同意功能实现指南

## 🎯 功能概述

本功能在学生登录后添加隐私条款同意界面，确保用户在使用系统前明确同意隐私政策。

## 🏗️ 实现架构

### 1. 数据库表结构
```sql
-- 表名：privacy_agreement
-- 字段：SNH (VARCHAR类型，存储学号哈希值)
CREATE TABLE privacy_agreement (
    id SERIAL PRIMARY KEY,
    SNH VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. 核心组件
- **隐私条款页面**: `/app/privacy-agreement/page.tsx`
- **API端点**: `/app/api/auth/privacy-agreement/route.ts`
- **中间件检查**: `middleware.ts`
- **Word文档读取**: `lib/word-reader.ts`

### 3. 工作流程
```
学生登录 → 检查隐私条款同意状态 → 
├─ 已同意 → 进入dashboard
└─ 未同意 → 显示隐私条款页面 → 同意后进入dashboard
```

## 🚀 部署步骤

### 步骤1：创建数据库表
在Supabase SQL Editor中运行 `create-privacy-table.sql` 脚本：

```sql
-- 复制 create-privacy-table.sql 的内容到Supabase SQL Editor
-- 点击 "Run" 执行脚本
```

### 步骤2：安装依赖
```bash
cd butp
npm install mammoth
```

### 步骤3：上传Word文档
将 `隐私政策与用户数据使用条款_clean_Aug2025.docx` 文件上传到 `public/` 文件夹。

### 步骤4：测试功能
运行测试脚本：
```bash
node test-privacy-agreement.js
```

## 🔧 配置说明

### 1. 环境变量
无需额外环境变量，使用现有的Supabase配置。

### 2. 文件路径
- Word文档路径: `/public/隐私政策与用户数据使用条款_clean_Aug2025.docx`
- 隐私条款页面: `/privacy-agreement`
- API端点: `/api/auth/privacy-agreement`

### 3. 中间件配置
中间件会自动检查以下路径是否需要隐私条款同意：
- 受保护路径: `/dashboard`, `/profile`, `/grades`, `/analysis` 等
- 豁免路径: `/privacy-agreement`, `/login`, `/` 等

## 📱 用户界面

### 1. 页面布局
- 响应式设计，支持移动端和桌面端
- 清晰的隐私条款内容展示
- 同意/不同意按钮
- 加载状态和错误提示

### 2. 多语言支持
- 中文和英文界面
- 使用语言上下文系统
- 翻译键以 `privacy.*` 开头

### 3. 交互流程
1. 用户登录成功后自动检查隐私条款状态
2. 未同意用户自动跳转到隐私条款页面
3. 用户阅读条款后点击"我同意"
4. 同意成功后跳转到dashboard
5. 不同意则返回登录页面

## 🛡️ 安全特性

### 1. 数据保护
- 只记录学号哈希值，不记录明文信息
- 使用Supabase RLS策略保护数据
- 用户只能访问自己的记录

### 2. 访问控制
- 中间件级别的权限检查
- API端点的身份验证
- 防止未授权访问

### 3. 审计日志
- 记录同意时间
- 支持撤回同意功能
- 完整的操作追踪

## 🔍 故障排除

### 1. 常见问题

#### 问题：Word文档无法读取
**解决方案**：
- 检查文件路径是否正确
- 确认文件格式为.docx
- 查看浏览器控制台错误信息
- 使用默认内容作为备选方案

#### 问题：数据库连接失败
**解决方案**：
- 检查Supabase配置
- 确认网络连接正常
- 验证API密钥有效性

#### 问题：中间件检查失败
**解决方案**：
- 检查中间件配置
- 确认路由路径设置正确
- 查看服务器日志

### 2. 调试工具
- 使用 `test-privacy-agreement.js` 测试脚本
- 检查浏览器开发者工具
- 查看Supabase日志
- 使用中间件调试信息

## 📊 监控和维护

### 1. 性能监控
- 数据库查询性能
- API响应时间
- 页面加载速度

### 2. 数据统计
- 同意率统计
- 用户行为分析
- 系统使用情况

### 3. 定期维护
- 更新隐私条款内容
- 检查数据库性能
- 更新安全策略

## 🔄 更新和扩展

### 1. 内容更新
- 修改Word文档内容
- 更新默认内容
- 调整界面文案

### 2. 功能扩展
- 添加更多同意选项
- 支持条款版本管理
- 增加用户偏好设置

### 3. 集成扩展
- 与其他系统集成
- 支持多种文档格式
- 添加电子签名功能

## 📝 注意事项

1. **法律合规**: 确保隐私条款内容符合相关法律法规
2. **用户通知**: 重大条款变更需要通知用户重新同意
3. **数据备份**: 定期备份隐私条款同意记录
4. **性能优化**: 避免频繁的数据库查询影响用户体验
5. **错误处理**: 提供友好的错误提示和恢复机制

## 🎉 完成检查清单

- [ ] 数据库表创建完成
- [ ] 依赖包安装完成
- [ ] Word文档上传完成
- [ ] 功能测试通过
- [ ] 多语言支持完成
- [ ] 安全策略配置完成
- [ ] 错误处理完善
- [ ] 文档更新完成

## 📞 技术支持

如果遇到问题，请：
1. 查看本文档的故障排除部分
2. 运行测试脚本获取详细信息
3. 检查浏览器控制台和服务器日志
4. 联系开发团队获取帮助

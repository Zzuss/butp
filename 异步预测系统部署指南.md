# 异步预测系统部署指南

## 🎯 概述
本文档说明如何在阿里云服务器上部署异步预测系统，包括文件部署、服务配置和Nginx设置。

## 📁 1. 文件部署

### 部署位置
```bash
# 将本地 function_aliyun 文件夹上传到服务器指定位置
/root/function_aliyun/
```

### 上传方式
```bash
# 使用scp上传（在本地执行）
scp -r function_aliyun/ root@your-server-ip:/root/

# 或使用rsync
rsync -av function_aliyun/ root@your-server-ip:/root/function_aliyun/
```

## 🌐 2. Nginx配置

### 配置文件位置
```bash
/etc/nginx/sites-available/prediction
```

### 配置内容
```nginx
server {
    listen 8080;
    server_name _;
    
    # 日志配置  
    access_log /var/log/nginx/prediction-api.access.log;
    error_log /var/log/nginx/prediction-api.error.log;
    
    # 健康检查和专业列表路由到8083
    location ~ ^/(health|api/majors|status)$ {
        proxy_pass http://127.0.0.1:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
   
    
    # 默认路由到8083（轻量接口）
    location / {
        proxy_pass http://127.0.0.1:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
```

### 启用配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/prediction /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

## ⚙️ 3. 服务启动

### 环境准备
```bash
# 进入项目目录
cd /root/function_aliyun

# 安装Python依赖（如果需要）
pip3 install -r requirements.txt
```

### 
### 启动8083端口服务（预测算法服务）
```bash
cd /root/function_aliyun
nohup python3 async_api_server.py --port 8083 > async_api_server.log 2>&1 &
```

## 🔍 4. 服务管理

### 查看服务状态
```bash
# 查看运行的Python服务
ps aux | grep python3

# 查看端口占用情况
netstat -tlnp | grep -E ':(8083|8080)'

# 查看Nginx状态
sudo systemctl status nginx
```

### 查看日志
```bash
# 查看服务日志
tail -f /root/function_aliyun/async_api_server.log

# 查看Nginx日志
sudo tail -f /var/log/nginx/prediction-api.access.log
sudo tail -f /var/log/nginx/prediction-api.error.log
```

### 重启服务
```bash
# 停止现有服务
pkill -f "python3.*8083"

# 重新启动服务
cd /root/function_aliyun
nohup python3 async_api_server.py --port 8083 > async_api_server.log 2>&1 &

# 重启Nginx
sudo systemctl restart nginx
```

## 🎯 5. 验证部署

### 健康检查
```bash
# 检查轻量服务
curl http://localhost:8083/health

# 检查Nginx代理
curl http://localhost:8080/health

# 检查外网访问（替换为实际IP）
curl http://your-server-ip:8080/health
```

### 功能测试
```bash
# 测试专业列表API
curl http://your-server-ip:8080/api/majors

# 测试预测API状态
curl http://your-server-ip:8080/status
```

## 📋 6. 部署检查清单

- [ ] `function_aliyun` 文件夹已上传到 `/root/function_aliyun/`
- [ ] Nginx配置文件已创建并启用
- [ ] 8083端口预测服务已启动
- [ ] Nginx服务正常运行
- [ ] 所有健康检查通过
- [ ] 防火墙已开放8080端口

## 🚨 7. 常见问题

### 服务无法启动
- 检查Python依赖是否安装完整
- 确认端口没有被其他进程占用
- 查看日志文件排查具体错误

### Nginx代理失败
- 检查upstream服务是否正常运行
- 验证Nginx配置文件语法
- 查看Nginx错误日志

### 超时问题
- 确认Nginx超时配置已正确设置
- 检查服务器性能是否足够
- 监控内存和CPU使用情况

---

**部署完成后，异步预测系统将通过8080端口对外提供服务！**

# ðŸš€ CASè®¤è¯éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

## âœ… å·²å®Œæˆçš„æ­¥éª¤

### 1. ä»£ç è¿ç§»å’Œæž„å»ºä¿®å¤ âœ“
- âœ… æ›´æ–°äº†4ä¸ªæ–‡ä»¶çš„æ—§è®¤è¯ç³»ç»Ÿå¼•ç”¨
- âœ… ä¿®å¤äº†æ‰€æœ‰TypeScriptç¼–è¯‘é”™è¯¯
- âœ… æ¸…ç†äº†ESLintè­¦å‘Š
- âœ… æž„å»ºæˆåŠŸå®Œæˆ (`npm run build`)

### 2. ä»£ç†æœåŠ¡å™¨éƒ¨ç½² âœ“
- âœ… åœ¨`10.3.58.3:8080`æˆåŠŸéƒ¨ç½²ä»£ç†æœåŠ¡å™¨
- âœ… PM2è¿›ç¨‹ç®¡ç†æ­£å¸¸è¿è¡Œ
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹å·¥ä½œæ­£å¸¸

### 3. æœ¬åœ°CASåŠŸèƒ½éªŒè¯ âœ“
- âœ… Mock CASç™»å½•é¡µé¢ (`/api/mock/cas/login`) è¿”å›ž200
- âœ… ç”¨æˆ·APIç«¯ç‚¹ (`/api/auth/user`) æ­£ç¡®è¿”å›ž401
- âœ… æ‰€æœ‰CAS APIç«¯ç‚¹å·²æž„å»ºå¹¶éƒ¨ç½²

## ðŸ”„ æŽ¥ä¸‹æ¥éœ€è¦å®Œæˆçš„æ­¥éª¤

### æ­¥éª¤4: æœ¬åœ°Mock CASå®Œæ•´æµ‹è¯•

**æ“ä½œæ–¹æ³•**ï¼š
1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000/profile`
2. åº”è¯¥è‡ªåŠ¨é‡å®šå‘åˆ°Mock CASç™»å½•é¡µé¢
3. ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•ï¼ˆå¦‚ï¼šå­¦å·`2021211001`ï¼Œå¯†ç `test123`ï¼‰
4. éªŒè¯èƒ½å¦æˆåŠŸè¿”å›žå¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

**é¢„æœŸç»“æžœ**ï¼š
- âœ… è‡ªåŠ¨è·³è½¬åˆ°Mock CASç™»å½•é¡µé¢
- âœ… èƒ½å¤Ÿä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•
- âœ… ç™»å½•åŽæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åï¼šå¼ ä¸‰ï¼Œå­¦å·ï¼š2021211001ï¼‰
- âœ… ä¾§è¾¹æ æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
- âœ… å¯ä»¥æ­£å¸¸è®¿é—®å…¶ä»–å—ä¿æŠ¤é¡µé¢

### æ­¥éª¤5: é…ç½®ç”Ÿäº§çŽ¯å¢ƒ

**åœ¨butp.techæœåŠ¡å™¨ä¸Šæ‰§è¡Œ**ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/your/nextjs/project

# 2. åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®
cat > .env.local << 'EOF'
NEXT_PUBLIC_SITE_URL=https://butp.tech
SESSION_SECRET_KEY=ä½ çš„è¶…å®‰å…¨32ä½ä»¥ä¸Šå¯†é’¥
NODE_ENV=production
EOF

# 3. ç”Ÿæˆå®‰å…¨å¯†é’¥
openssl rand -base64 32
# å°†ç”Ÿæˆçš„å¯†é’¥æ›¿æ¢åˆ°SESSION_SECRET_KEY

# 4. å®‰è£…ä¾èµ–å¹¶æž„å»º
npm install
npm run build

# 5. å¯åŠ¨åº”ç”¨
pm2 start npm --name "butp-app" -- start
pm2 save
```

### æ­¥éª¤6: æµ‹è¯•ç”Ÿäº§çŽ¯å¢ƒCASè®¤è¯

**æµ‹è¯•æµç¨‹**ï¼š

1. **è®¿é—®å—ä¿æŠ¤é¡µé¢**ï¼š
   ```
   https://butp.tech/profile
   ```

2. **éªŒè¯CASç™»å½•æµç¨‹**ï¼š
   - åº”è¯¥é‡å®šå‘åˆ°ï¼š`https://auth.bupt.edu.cn/authserver/login?service=http://10.3.58.3:8080/api/auth/cas/callback`
   - ä½¿ç”¨çœŸå®žåŒ—é‚®è´¦å·ç™»å½•
   - CASå›žè°ƒåˆ°ï¼š`http://10.3.58.3:8080/api/auth/cas/callback?ticket=xxx`
   - ä»£ç†è½¬å‘åˆ°ï¼š`https://butp.tech/api/auth/cas/verify?ticket=xxx`
   - æœ€ç»ˆè¿”å›žï¼š`https://butp.tech/profile`

3. **éªŒè¯ç”¨æˆ·ä¿¡æ¯**ï¼š
   - ä¾§è¾¹æ æ˜¾ç¤ºçœŸå®žå§“åå’Œå­¦å·
   - å¯ä»¥è®¿é—®æ‰€æœ‰å—ä¿æŠ¤é¡µé¢
   - ç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ðŸ” æµ‹è¯•å’ŒéªŒè¯å‘½ä»¤

### æœ¬åœ°æµ‹è¯•
```bash
# æ£€æŸ¥Mock CASç™»å½•é¡µé¢
curl http://localhost:3000/api/mock/cas/login?service=http://localhost:3000/api/auth/cas/callback

# æ£€æŸ¥ç”¨æˆ·APIï¼ˆåº”è¯¥è¿”å›ž401ï¼‰
curl http://localhost:3000/api/auth/user
```

### ç”Ÿäº§çŽ¯å¢ƒæµ‹è¯•
```bash
# æµ‹è¯•ä»£ç†æœåŠ¡å™¨å¥åº·çŠ¶æ€
curl http://10.3.58.3:8080/health

# æµ‹è¯•åº”ç”¨å¥åº·çŠ¶æ€
curl https://butp.tech/api/auth/user

# æµ‹è¯•ä»£ç†å›žè°ƒåŠŸèƒ½
curl -I "http://10.3.58.3:8080/api/auth/cas/callback?ticket=test"
```

## ðŸŽ¯ å®Œæ•´è®¤è¯æµç¨‹å›¾

### æœ¬åœ°å¼€å‘çŽ¯å¢ƒ (Mock CAS)
```
ç”¨æˆ·è®¿é—® localhost:3000/profile
    â†“
é‡å®šå‘åˆ° localhost:3000/api/mock/cas/login
    â†“
ç”¨æˆ·é€‰æ‹©æµ‹è¯•è´¦å·ç™»å½•
    â†“
å›žè°ƒåˆ° localhost:3000/api/auth/cas/callback?ticket=mock-xxx
    â†“
éªŒè¯mock ticketï¼Œåˆ›å»ºä¼šè¯
    â†“
é‡å®šå‘åˆ° localhost:3000/profileï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
```

### ç”Ÿäº§çŽ¯å¢ƒ (çœŸå®žCAS)
```
ç”¨æˆ·è®¿é—® butp.tech/profile
    â†“
é‡å®šå‘åˆ° auth.bupt.edu.cn/authserver/login?service=10.3.58.3:8080/api/auth/cas/callback
    â†“
ç”¨æˆ·è¾“å…¥åŒ—é‚®è´¦å·å¯†ç 
    â†“
CASå›žè°ƒåˆ° 10.3.58.3:8080/api/auth/cas/callback?ticket=ST-xxx
    â†“
ä»£ç†è½¬å‘åˆ° butp.tech/api/auth/cas/verify?ticket=ST-xxx
    â†“
éªŒè¯çœŸå®žticketï¼ŒèŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ›å»ºä¼šè¯
    â†“
é‡å®šå‘åˆ° butp.tech/profileï¼Œæ˜¾ç¤ºçœŸå®žç”¨æˆ·ä¿¡æ¯
```

## ðŸŽ‰ éƒ¨ç½²å®Œæˆæ ‡å¿—

å½“ä»¥ä¸‹æ‰€æœ‰é¡¹ç›®éƒ½é€šè¿‡æ—¶ï¼ŒCASè®¤è¯åŠŸèƒ½éƒ¨ç½²å®Œæˆï¼š

### æœ¬åœ°å¼€å‘çŽ¯å¢ƒ
- [ ] è®¿é—®`localhost:3000/profile`èƒ½è·³è½¬åˆ°Mock CAS
- [ ] èƒ½ä½¿ç”¨æµ‹è¯•è´¦å·æˆåŠŸç™»å½•
- [ ] ç™»å½•åŽæ­£ç¡®æ˜¾ç¤ºmockç”¨æˆ·ä¿¡æ¯
- [ ] ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
- [ ] ç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### ç”Ÿäº§çŽ¯å¢ƒ
- [ ] ä»£ç†æœåŠ¡å™¨åœ¨`10.3.58.3:8080`æ­£å¸¸è¿è¡Œ
- [ ] åº”ç”¨å·²éƒ¨ç½²åˆ°`https://butp.tech`
- [ ] è®¿é—®`butp.tech/profile`èƒ½è·³è½¬åˆ°çœŸå®žCAS
- [ ] èƒ½ä½¿ç”¨çœŸå®žåŒ—é‚®è´¦å·ç™»å½•
- [ ] ç™»å½•åŽæ­£ç¡®æ˜¾ç¤ºçœŸå®žç”¨æˆ·ä¿¡æ¯
- [ ] æ‰€æœ‰å—ä¿æŠ¤é¡µé¢æ­£å¸¸è®¿é—®
- [ ] ä¼šè¯ç®¡ç†åŠŸèƒ½æ­£å¸¸

## ðŸš¨ å¸¸è§é—®é¢˜æŽ’æŸ¥

### é—®é¢˜1: Mock CASç™»å½•å¤±è´¥
- æ£€æŸ¥`NODE_ENV=development`æ˜¯å¦è®¾ç½®
- ç¡®è®¤å¼€å‘æœåŠ¡å™¨åœ¨`localhost:3000`è¿è¡Œ

### é—®é¢˜2: ç”Ÿäº§çŽ¯å¢ƒCASç™»å½•å¤±è´¥
- ç¡®è®¤`NODE_ENV=production`å·²è®¾ç½®
- æ£€æŸ¥ä»£ç†æœåŠ¡å™¨çŠ¶æ€ï¼š`./cas-proxy-ctl.sh status`
- æŸ¥çœ‹ä»£ç†æœåŠ¡å™¨æ—¥å¿—ï¼š`./cas-proxy-ctl.sh logs`

### é—®é¢˜3: ä¼šè¯æ— æ³•åˆ›å»º
- ç¡®è®¤`SESSION_SECRET_KEY`é•¿åº¦â‰¥32å­—ç¬¦
- æ£€æŸ¥HTTPSè¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
- éªŒè¯cookieè®¾ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜4: ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºå¼‚å¸¸
- ç¡®è®¤æ‰€æœ‰ä»£ç è¿ç§»å·²å®Œæˆ
- æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°JavaScripté”™è¯¯
- éªŒè¯`/api/auth/user`ç«¯ç‚¹è¿”å›žæ•°æ®

## ðŸ“ž éœ€è¦å¸®åŠ©æ—¶çš„æ£€æŸ¥é¡¹ç›®

1. **ä»£ç†æœåŠ¡å™¨æ—¥å¿—**: `./cas-proxy-ctl.sh logs`
2. **Next.jsåº”ç”¨æ—¥å¿—**: `pm2 logs butp-app`
3. **æµè§ˆå™¨å¼€å‘è€…å·¥å…·**: Networkæ ‡ç­¾æŸ¥çœ‹è¯·æ±‚
4. **CASæœåŠ¡å™¨å¯è®¿é—®æ€§**: `https://auth.bupt.edu.cn/authserver`
5. **çŽ¯å¢ƒå˜é‡é…ç½®**: æ£€æŸ¥`.env.local`æ–‡ä»¶å†…å®¹ 
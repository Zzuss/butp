import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  try {
    const { studentHash, modifiedScores, source2Scores } = await request.json()

    // 1. éªŒè¯è¾“å…¥æ•°æ®
    if (!studentHash) {
      return NextResponse.json({ error: 'Student hash is required' }, { status: 400 })
    }

    if (!modifiedScores || !Array.isArray(modifiedScores)) {
      return NextResponse.json({ error: 'Modified scores are required and must be an array' }, { status: 400 })
    }

    if (!source2Scores || !Array.isArray(source2Scores)) {
      return NextResponse.json({ error: 'Source2 scores are required and must be an array' }, { status: 400 })
    }

    const trimmedHash = studentHash.trim();

    if (!/^[a-f0-9]{64}$/i.test(trimmedHash)) {
      return NextResponse.json({ error: 'Invalid hash format' }, { status: 400 })
    }

    console.log(`ğŸ” å¼€å§‹æ•´åˆæ•°æ®ï¼Œå­¦ç”Ÿ: ${trimmedHash.slice(0, 8)}...`)
    console.log(`ğŸ“Š æ¥æº1æ•°æ®æ•°é‡: ${modifiedScores.length}`)
    console.log(`ğŸ“Š æ¥æº2æ•°æ®æ•°é‡: ${source2Scores.length}`)

    // 2. å¤„ç†æ¥æº2æ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨å‰ç«¯ä¼ é€’çš„ç¼“å­˜æ•°æ®ï¼‰
    let source2Data = source2Scores;
    console.log(`âœ… æ¥æº2æ•°æ®å·²ä»ç¼“å­˜è·å–ï¼Œæ•°é‡: ${source2Data.length}`)

    // 3. è¯¾ç¨‹ä¿¡æ¯æ˜ å°„ï¼ˆä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„è¡¨ï¼‰
    console.log(`ğŸ” ä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„è¡¨è·å–è¯¾å·...`)

    // æ¥æº1 category åˆ°9ä¸ªç‰¹å¾å€¼çš„æ˜ å°„è¡¨
    const source1CategoryToFeatureMapping: Record<string, string> = {
      // å…¬å…±è¯¾ç¨‹
      'å…¬å…±è¯¾': 'å…¬å…±è¯¾ç¨‹',
      'ç´ è´¨æ•™è‚²': 'å…¬å…±è¯¾ç¨‹',
      'ç´ è´¨æ•™è‚²-äººæ–‡ç¤¾ç§‘ç±»': 'å…¬å…±è¯¾ç¨‹',
      'ç´ è´¨æ•™è‚²-ç†å·¥ç±»': 'å…¬å…±è¯¾ç¨‹',
      'ç´ è´¨æ•™è‚²-è‰ºæœ¯ç±»': 'å…¬å…±è¯¾ç¨‹',
      'ä½“è‚²': 'å…¬å…±è¯¾ç¨‹',
      'ä½“è‚²ã€ç¾è‚²': 'å…¬å…±è¯¾ç¨‹',
      'ä½“è‚²ä¸“é¡¹è¯¾': 'å…¬å…±è¯¾ç¨‹',
      'ä½“è‚²ç±»': 'å…¬å…±è¯¾ç¨‹',
      'ä½“è‚²è¯¾ç­‰': 'å…¬å…±è¯¾ç¨‹',
      'å®‰å…¨æ•™è‚²': 'å…¬å…±è¯¾ç¨‹',
      'å…¶ä»–': 'å…¬å…±è¯¾ç¨‹',
      'å¿ƒç†å¥åº·': 'å…¬å…±è¯¾ç¨‹',
      'å†›äº‹ç†è®º': 'å…¬å…±è¯¾ç¨‹',
      
      // å®è·µè¯¾ç¨‹
      'å®è·µæ•™å­¦': 'å®è·µè¯¾ç¨‹',
      'å®è·µæ•™å­¦è¯¾': 'å®è·µè¯¾ç¨‹',
      
      // æ•°å­¦ç§‘å­¦
      'æ•°å­¦ä¸è‡ªç„¶ç§‘å­¦': 'æ•°å­¦ç§‘å­¦',
      
      // æ”¿æ²»è¯¾ç¨‹
      'æ€æƒ³æ”¿æ²»ç†è®º': 'æ”¿æ²»è¯¾ç¨‹',
      'æ€æƒ³æ”¿æ²»ç†è®ºè¯¾': 'æ”¿æ²»è¯¾ç¨‹',
      
      // åŸºç¡€å­¦ç§‘
      'æ•°å­¦ä¸è‡ªç„¶ç§‘å­¦åŸºç¡€': 'åŸºç¡€å­¦ç§‘',
      'è®¡ç®—æœºåŸºç¡€': 'åŸºç¡€å­¦ç§‘',
      
      // åˆ›æ–°è¯¾ç¨‹
      'æ ¡çº§åˆ›æ–°åˆ›ä¸šè¯¾ç¨‹': 'åˆ›æ–°è¯¾ç¨‹',
      'æ ¡çº§åŒåˆ›è¯¾': 'åˆ›æ–°è¯¾ç¨‹',
      'é™¢çº§åŒåˆ›è¯¾': 'åˆ›æ–°è¯¾ç¨‹',
      'å­¦é™¢ç‰¹è‰²åˆ›æ–°5å­¦åˆ†': 'åˆ›æ–°è¯¾ç¨‹',
      'å­¦é™¢ç‰¹è‰²åˆ›æ–°6å­¦åˆ†': 'åˆ›æ–°è¯¾ç¨‹',
      'å­¦é™¢ç‰¹è‰²åˆ›æ–°å­¦åˆ†ï¼ˆ5å­¦åˆ†)': 'åˆ›æ–°è¯¾ç¨‹',
      'å­¦é™¢ç‰¹è‰²åˆ›æ–°å¿…ä¿®3å­¦åˆ†': 'åˆ›æ–°è¯¾ç¨‹',
      'å­¦é™¢ç‰¹è‰²åˆ›æ–°å¿…ä¿®5å­¦åˆ†': 'åˆ›æ–°è¯¾ç¨‹',
      
      // è‹±è¯­è¯¾ç¨‹
      'å¤–è¯­': 'è‹±è¯­è¯¾ç¨‹',
      'è‹±è¯­': 'è‹±è¯­è¯¾ç¨‹',
      
      // åŸºç¡€ä¸“ä¸š
      'ä¸“ä¸šåŸºç¡€': 'åŸºç¡€ä¸“ä¸š',
      'ä¸“ä¸šè¯¾åŸºç¡€': 'åŸºç¡€ä¸“ä¸š',
      'å­¦ç§‘åŸºç¡€': 'åŸºç¡€ä¸“ä¸š',
      
      // ä¸“ä¸šè¯¾ç¨‹
      'ä¸“ä¸šè¯¾': 'ä¸“ä¸šè¯¾ç¨‹',
      'å¶åŸ¹å¤§å­¦é™¢è¾…ä¿®': 'ä¸“ä¸šè¯¾ç¨‹'
    };

    // æ¥æº2 è¯¾ç¨‹ç±»å‹åˆ°ç±»åˆ«çš„æ˜ å°„è¡¨
    const source2CourseTypeToCategoryMapping: Record<string, string> = {
      'æ€æƒ³æ”¿æ²»ç†è®ºè¯¾': 'æ”¿æ²»è¯¾ç¨‹',
      'å…¬å…±è¯¾': 'å…¬å…±è¯¾ç¨‹',
      'ä¸“ä¸šè¯¾': 'ä¸“ä¸šè¯¾ç¨‹',
      'å®è·µæ•™å­¦è¯¾': 'å®è·µè¯¾ç¨‹',
      'æ ¡çº§åŒåˆ›è¯¾': 'åˆ›æ–°è¯¾ç¨‹',
      'é™¢çº§åŒåˆ›è¯¾': 'åˆ›æ–°è¯¾ç¨‹',
      'å…¶ä»–': 'åŸºç¡€å­¦ç§‘'
    };
    
    //æ„Ÿè§‰ä¸‹é¢è¿™ä¸ªè¯¾å·æ˜ å°„è¡¨æ²¡ä»€ä¹ˆç”¨ï¼ŒåæœŸç»™ä¼˜åŒ–åˆ æ‰
    // è¯¾ç¨‹åç§°åˆ°è¯¾ç¨‹ç¼–å·çš„æ˜ å°„è¡¨ï¼ˆå››ä¸ªä¸“ä¸šå®Œæ•´ç‰ˆï¼‰
    const courseNameToIdMapping: Record<string, string> = {
      // ===== æ”¿æ²»ç†è®ºè¯¾ç¨‹ =====
      "æ€æƒ³é“å¾·ä¸æ³•æ²»": "3322100012",
      "ä¸­å›½è¿‘ç°ä»£å²çº²è¦": "3322100060",
      "é©¬å…‹æ€ä¸»ä¹‰åŸºæœ¬åŸç†": "3322100021",
      "æ¯›æ³½ä¸œæ€æƒ³å’Œä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®ºä½“ç³»æ¦‚è®º": "3322100082",
      "ä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰æ€æƒ³æ¦‚è®º": "3322100091",
      "å½¢åŠ¿ä¸æ”¿ç­–1": "1052100010",
      "å½¢åŠ¿ä¸æ”¿ç­–2": "1052100020",
      "å½¢åŠ¿ä¸æ”¿ç­–3": "1052100030",
      "å½¢åŠ¿ä¸æ”¿ç­–4": "1052100040",
      "å½¢åŠ¿ä¸æ”¿ç­–5": "1052100050",
      "æ€æƒ³é“å¾·ä¸æ³•æ²»ï¼ˆå®è·µç¯èŠ‚ï¼‰": "3322100013",
      "æ¯›æ³½ä¸œæ€æƒ³å’Œä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®ºä½“ç³»æ¦‚è®ºå®": "3322100083",
      
      // ===== æ•°å­¦ä¸è‡ªç„¶ç§‘å­¦åŸºç¡€ =====
      "çº¿æ€§ä»£æ•°": "3412110079",
      "é«˜ç­‰æ•°å­¦A(ä¸Š)": "3412110019",
      "é«˜ç­‰æ•°å­¦A(ä¸‹)": "3412110029",
      "é«˜ç­‰æ•°å­¦B(ä¸Š)": "3412110039",
      "é«˜ç­‰æ•°å­¦B(ä¸‹)": "3412110049",
      "é«˜ç­‰æ•°å­¦C(ä¸Š)": "3412110059",
      "é«˜ç­‰æ•°å­¦C(ä¸‹)": "3412110069",
      "å¤§å­¦ç‰©ç†Dï¼ˆä¸Šï¼‰": "3412120019",
      "å¤§å­¦ç‰©ç†Dï¼ˆä¸‹ï¼‰": "3412120029",
      "å¤§å­¦ç‰©ç†Eï¼ˆä¸Šï¼‰": "3412120039",
      "å¤§å­¦ç‰©ç†Eï¼ˆä¸‹ï¼‰": "3412120049",
      "å·¥ç¨‹æ•°å­¦": "3412110129",
      "æ¦‚ç‡è®ºä¸éšæœºè¿‡ç¨‹": "3412110099",
      "å¤å˜å‡½æ•°ä¸ç§¯åˆ†å˜æ¢": "3412110109",
      "æ•°å­¦å»ºæ¨¡": "3412110119",
      "ç‰©ç†å®éªŒC": "3412130049",
      "ç‰©ç†å®éªŒD": "3412130059",
      
      // ===== è‹±è¯­è¯¾ç¨‹ =====
      "ç»¼åˆè‹±è¯­ï¼ˆä¸Šï¼‰": "3312110316",
      "ç»¼åˆè‹±è¯­ï¼ˆä¸‹ï¼‰": "3312110326",
      "è¿›é˜¶å¬è¯´ï¼ˆä¸Šï¼‰": "3312110336",
      "è¿›é˜¶å¬è¯´ï¼ˆä¸‹ï¼‰": "3312110346",
      "å­¦æœ¯è‹±è¯­": "3312110356",
      "ä¸“ä¸šè‹±è¯­": "3312110366",
      "è‹±è¯­å£è¯­": "3312110376",
      "è‹±è¯­å†™ä½œ": "3312110386",
      
      // ===== è®¡ç®—æœºåŸºç¡€è¯¾ç¨‹ =====
      "ç¨‹åºè®¾è®¡åŸºç¡€": "3132100090",
      "æ•°æ®ç»“æ„": "3132100100",
      "ç®—æ³•è®¾è®¡ä¸åˆ†æ": "3132100110",
      "è®¡ç®—æœºç»„æˆåŸç†": "3132100120",
      "æ“ä½œç³»ç»Ÿ": "3132100130",
      "æ•°æ®åº“åŸç†": "3132100140",
      "è®¡ç®—æœºç½‘ç»œåŸç†": "3132100150",
      "è½¯ä»¶å·¥ç¨‹": "3512163043",
      "æ•°æ®è®¾è®¡": "3512156011",
      "Javaé«˜çº§è¯­è¨€ç¨‹åºè®¾è®¡": "3512142011",
      "C++ç¨‹åºè®¾è®¡": "3512142021",
      "Pythonç¨‹åºè®¾è®¡": "3512142031",
      "Webå¼€å‘æŠ€æœ¯": "3512142041",
      "ç§»åŠ¨åº”ç”¨å¼€å‘": "3512142051",
      
      // ===== ç”µå­ä¿¡æ¯å·¥ç¨‹ä¸“ä¸šè¯¾ç¨‹ =====
      "ç”µå­ä¿¡æ¯å·¥ç¨‹ä¸“ä¸šå¯¼è®º": "3112191070",
      "ç”µå­ç³»ç»ŸåŸºç¡€": "3112191110",
      "ç”µå­ç”µè·¯åŸºç¡€": "3112190019",
      "æ¨¡æ‹Ÿç”µå­æŠ€æœ¯": "3112190029",
      "æ•°å­—ç”µå­æŠ€æœ¯": "3112190039",
      "ä¿¡å·ä¸ç³»ç»Ÿ": "B304BY0010",
      "æ•°å­—ä¿¡å·å¤„ç†": "3512155023",
      "é€šä¿¡åŸç†I": "3112100140",
      "é€šä¿¡åŸç†II": "3112100150",
      "ç”µç£åœºä¸ç”µç£æ³¢": "3122101058",
      "å¤©çº¿ä¸ç”µæ³¢ä¼ æ’­": "3122101068",
      "å¾®æ³¢æŠ€æœ¯": "3122101078",
      "å…‰çº¤é€šä¿¡": "3122101088",
      "ç§»åŠ¨é€šä¿¡": "3122101098",
      "å«æ˜Ÿé€šä¿¡": "3122101108",
      "æ•°å­—ç”µè·¯è®¾è®¡": "3512142023",
      "VLSIè®¾è®¡": "3512142033",
      "åµŒå…¥å¼ç³»ç»Ÿè®¾è®¡": "3512142043",
      "FPGAè®¾è®¡": "3512142053",
      "ç”µè·¯å®éªŒ": "3122108005",
      "é€šä¿¡åŸç†å®éªŒ": "3112100990",
      "ç”µå­å·¥è‰ºå®ä¹ ": "3112199020",
      "Design & Buildå®è®­ï¼ˆç”µå­ï¼‰": "3122106831",
      "ç”µå­ä¿¡æ¯å·¥ç¨‹ä¸“ä¸šå®ä¹ ": "3512190007",
      
      // ===== è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸šè¯¾ç¨‹ =====
      "è®¡ç®—æœºç§‘å­¦å¯¼è®º": "3212191070",
      "ç¦»æ•£æ•°å­¦": "3212190019",
      "æ•°å­—é€»è¾‘": "3212190029",
      "è®¡ç®—æœºä½“ç³»ç»“æ„": "3212190039",
      "ç¼–è¯‘åŸç†": "3212190049",
      "è½¯ä»¶æµ‹è¯•": "3212190059",
      "è½¯ä»¶é¡¹ç›®ç®¡ç†": "3212190069",
      "è®¡ç®—æœºç§‘å­¦ä¸“ä¸šå®ä¹ ": "3512190008",
      
      // ===== ç‰©è”ç½‘å·¥ç¨‹ä¸“ä¸šè¯¾ç¨‹ =====
      "ç‰©è”ç½‘å·¥ç¨‹å¯¼è®º": "3312191070",
      "ä¼ æ„Ÿå™¨æŠ€æœ¯": "3312190019",
      "RFIDæŠ€æœ¯": "3312190029",
      "æ— çº¿ä¼ æ„Ÿå™¨ç½‘ç»œ": "3312190039",
      "ç‰©è”ç½‘å®‰å…¨": "3312190049",
      "ç‰©è”ç½‘åº”ç”¨å¼€å‘": "3312190059",
      "æ™ºèƒ½å®¶å±…ç³»ç»Ÿ": "3312190069",
      "å·¥ä¸šç‰©è”ç½‘": "3312190079",
      "ç‰©è”ç½‘å·¥ç¨‹ä¸“ä¸šå®ä¹ ": "3512190009",
      
      // ===== äººå·¥æ™ºèƒ½ä¸“ä¸šè¯¾ç¨‹ =====
      "äººå·¥æ™ºèƒ½å¯¼è®º": "3912120120",
      "æœºå™¨å­¦ä¹ ": "3512152011",
      "æ·±åº¦å­¦ä¹ ": "3512152021",
      "ç¥ç»ç½‘ç»œ": "3512152031",
      "è®¡ç®—æœºè§†è§‰": "3512152041",
      "è‡ªç„¶è¯­è¨€å¤„ç†": "3512152051",
      "çŸ¥è¯†è¡¨ç¤ºä¸æ¨ç†": "3512152061",
      "ä¸“å®¶ç³»ç»Ÿ": "3512152071",
      "æ™ºèƒ½æœºå™¨äºº": "3512152081",
      "äººå·¥æ™ºèƒ½ä¸“ä¸šå®ä¹ ": "3512190010",
      
      // ===== ä¸“ä¸šåŸºç¡€è¯¾ç¨‹ =====
      "è®¡ç®—æœºç½‘ç»œ": "3112191080",
      "ä¿¡æ¯å®‰å…¨": "3112191090",
      "æ•°å­—å›¾åƒå¤„ç†": "3512152091",
      "æ¨¡å¼è¯†åˆ«": "3512152101",
      "æ•°æ®æŒ–æ˜": "3512152111",
      "ä¿¡æ¯è®º": "3112191960",
      "ç¼–ç ç†è®º": "3112191970",
      "ç°ä»£é€šä¿¡æŠ€æœ¯": "3112191980",
      
      // ===== ä¸“ä¸šè¯¾ç¨‹ =====
      "äº§å“å¼€å‘ä¸ç®¡ç†": "3512156071",
      "å¤šåª’ä½“åŸºç¡€": "3512153031",
      "æ•°å­—éŸ³é¢‘åŸºç¡€": "3512159421",
      "é«˜çº§å˜æ¢": "3512171801",
      "å›¾å½¢ä¸è§†é¢‘å¤„ç†": "3512162301",
      "äº¤äº’å¼åª’ä½“è®¾è®¡": "3512153051",
      "3Då›¾å½¢ç¨‹åºè®¾è®¡": "3512154053",
      "æ·±åº¦å­¦ä¹ ä¸è®¡ç®—è§†è§‰": "3512172411",
      "è™šæ‹Ÿç°å®æŠ€æœ¯": "3512153061",
      "å¢å¼ºç°å®æŠ€æœ¯": "3512153071",
      "æ¸¸æˆå¼€å‘": "3512153081",
      "æ•°å­—åª’ä½“æŠ€æœ¯": "3512153091",
      
      // ===== å®è·µè¯¾ç¨‹ =====
      "å†›è®­": "2122110003",
      "æ¯•ä¸šè®¾è®¡": "3512165214",
      
      // ===== å…¬å…±è¯¾ç¨‹ =====
      "ä½“è‚²åŸºç¡€": "3812150010",
      "å†›äº‹ç†è®º": "2122110002",
      "å¤§å­¦ç”Ÿå¿ƒç†å¥åº·": "2122120000",
      "å®‰å…¨æ•™è‚²": "2122100090",
      "å­¦æœ¯äº¤æµæŠ€èƒ½1": "3312110219",
      "å­¦æœ¯äº¤æµæŠ€èƒ½2": "3312110229",
      "ä¸ªäººå‘å±•è®¡åˆ’1": "3512130011",
      "ä¸ªäººå‘å±•è®¡åˆ’2": "3512140013",
      "ä¸ªäººå‘å±•è®¡åˆ’3": "3512150011",
      "åˆ›æ–°åˆ›ä¸šåŸºç¡€": "3512152121",
      "åˆ›æ–°æ€ç»´ä¸æ–¹æ³•": "3512152131",
      "åˆ›ä¸šå®è·µ": "3512152141",
      
      // ===== ç´ è´¨æ•™è‚²è¯¾ç¨‹ =====
      "äººæ–‡ç¤¾ç§‘ç±»": "3512152151",
      "è‰ºæœ¯ç±»": "3512152161",
      "ç†å·¥ç±»": "3512152171",
      "åˆ›æ–°åˆ›ä¸šç±»": "3512152181",
      "ç¤¾ä¼šå®è·µ": "3512152191",
      "å¿—æ„¿æœåŠ¡": "3512152201"
    };

    // å¤„ç†æ¥æº1æ•°æ®ï¼ˆä½¿ç”¨å‰ç«¯ä¼ é€’çš„ä¿®æ”¹æ•°æ®ï¼‰
    const source1Courses: any[] = [];
    if (modifiedScores && Array.isArray(modifiedScores) && modifiedScores.length > 0) {
      modifiedScores.forEach((course: any) => {
        // å½“å‰æˆç»©å°±æ˜¯ä¿®æ”¹åçš„æˆç»©
        const currentScore = typeof course.score === 'string' ? parseFloat(course.score) : course.score;
        
        // åº”ç”¨æ¥æº1çš„categoryæ˜ å°„ï¼ˆç›´æ¥ä»course.categoryè·å–ï¼‰
        const originalCategory = course.category || null;
        const mappedCategory = originalCategory ? source1CategoryToFeatureMapping[originalCategory] || 'åŸºç¡€å­¦ç§‘' : 'åŸºç¡€å­¦ç§‘';
        
        source1Courses.push({
          source: 'ä¸“ä¸šé¢„æµ‹è¡¨',
          courseName: course.courseName,
          score: currentScore,
          semester: course.semester || null,
          category: mappedCategory, // ä½¿ç”¨æ˜ å°„åçš„category
          credit: course.credit || null,
          rawData: course
        });
      });
    }
    
    console.log(`âœ… æ¥æº1æ•°æ®å¤„ç†å®Œæˆï¼Œè¯¾ç¨‹æ•°é‡: ${source1Courses.length}`)

    // æ·»åŠ ç¼“å­˜ä¿¡æ¯åˆ°å“åº”ä¸­
    const cacheInfo = {
      hasModifications: modifiedScores && Array.isArray(modifiedScores) && modifiedScores.length > 0,
      modifiedCoursesCount: modifiedScores && Array.isArray(modifiedScores) ? modifiedScores.length : 0,
      cacheKey: `${trimmedHash}_${modifiedScores && Array.isArray(modifiedScores) && modifiedScores.length > 0 ? 
        btoa(unescape(encodeURIComponent(JSON.stringify(modifiedScores)))).slice(0, 8) : 'original'}`
    };

    // å¤„ç†æ¥æº2æ•°æ®ï¼ˆä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„è¡¨è·å–è¯¾å·ï¼‰
    const source2Courses: any[] = [];
    if (source2Data) {
      source2Data.forEach((record: any) => {
        // å‰ç«¯ä¼ é€’çš„æ•°æ®å·²ç»æ ¼å¼åŒ–ï¼Œç›´æ¥ä½¿ç”¨
        if (record.source === 'academic_results') {
          source2Courses.push(record);
        } else {
          // å¦‚æœæ•°æ®æ ¼å¼ä¸æ ‡å‡†ï¼Œè¿›è¡ŒåŸºæœ¬è½¬æ¢
          let score = null;
          if (record.Grade || record.score) {
            const gradeStr = (record.Grade || record.score).toString();
            if (gradeStr.includes('.')) {
              score = parseFloat(gradeStr);
            } else {
              score = parseInt(gradeStr);
            }
          }
          
          const courseName = record.Course_Name || record.courseName;
          // ä¼˜å…ˆä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„è¡¨çš„è¯¾å·ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹æ•°æ®
          const courseId = courseNameToIdMapping[courseName] || record.Course_ID || record.courseId;
          
          source2Courses.push({
            source: 'academic_results',
            courseName: courseName,
            courseId: courseId, // ä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„è¡¨çš„è¯¾å·
            score: score,
            semester: record.Semester_Offered || record.semester,
            category: record.category || 'åŸºç¡€å­¦ç§‘',
            credit: record.Credit || record.credit,
            courseType: record.Course_Type || record.courseType,
            courseAttribute: record.Course_Attribute || record.courseAttribute,
            examType: record.Exam_Type || record.examType,
            rawData: record
          });
        }
      });
    }
    
    console.log(`âœ… æ¥æº2æ•°æ®å¤„ç†å®Œæˆï¼Œè¯¾ç¨‹æ•°é‡: ${source2Courses.length}`)

    // åˆå¹¶æ•°æ®ï¼ŒæŒ‰ç…§æ–°çš„è§„åˆ™ï¼šå…ˆæ¥æº2ï¼Œå†æ¥æº1
    const allCourses: any[] = [];
    const processedCourseNames = new Set<string>();

    // ç¬¬ä¸€æ­¥ï¼šå…ˆç½®å…¥æ¥æº2çš„æ•°æ®
    // è§„åˆ™ï¼šå¦‚æœæ¥æº2ä¸­æˆç»©ä¸º0æˆ–ä¸å­˜åœ¨ï¼Œåˆ™ä¸ç½®å…¥æ€»è¡¨
    source2Courses.forEach(course => {
      if (course.score !== null && course.score !== undefined && course.score !== 0) {
        allCourses.push(course);
        processedCourseNames.add(course.courseName);
      }
    });

    // ç¬¬äºŒæ­¥ï¼šå†ç½®å…¥æ¥æº1çš„æ•°æ®
    // è§„åˆ™ï¼š
    // 1. å¦‚æœæ¥æº1æˆç»©ä¸æ¥æº2å†²çªï¼Œç”¨æ¥æº1æˆç»©è¦†ç›–
    // 2. å¦‚æœæ¥æº1æˆç»©ä¸ºnullï¼Œä¸ç½®å…¥
    // 3. å¦‚æœæ¥æº1æˆç»©ä¸º0ï¼Œè¦ç½®å…¥æ€»è¡¨
    source1Courses.forEach(course => {
      if (course.score !== null && course.score !== undefined) { // æˆç»©ä¸ä¸ºnullæ‰å¤„ç†
        const existingIndex = allCourses.findIndex(c => c.courseName === course.courseName);
        
        if (existingIndex >= 0) {
          // å†²çªæƒ…å†µï¼šç”¨æ¥æº1æˆç»©è¦†ç›–
          allCourses[existingIndex] = {
            ...allCourses[existingIndex],
            score: course.score,
            source: 'ä¸“ä¸šé¢„æµ‹è¡¨ (è¦†ç›–)'
          };
        } else {
          // æ–°è¯¾ç¨‹ï¼šç›´æ¥æ·»åŠ 
          allCourses.push({
            ...course,
            source: 'ä¸“ä¸šé¢„æµ‹è¡¨'
          });
          processedCourseNames.add(course.courseName);
        }
      }
    });

    console.log(`âœ… æ•°æ®æ•´åˆå®Œæˆï¼Œæ€»è¯¾ç¨‹æ•°: ${allCourses.length}`)
    
    return NextResponse.json({
      success: true,
      data: {
        studentInfo: {
          SNH: trimmedHash,
          major: source2Data?.[0]?.Current_Major || source2Data?.[0]?.currentMajor,
          year: null
        },
        summary: {
          totalCourses: allCourses.length,
          source1Count: source1Courses.length,
          source2Count: source2Courses.length,
          uniqueCourses: processedCourseNames.size
        },
        source1Data: source1Courses,
        source2Data: source2Courses,
        allCourses: allCourses,
        courseMapping: courseNameToIdMapping, // æ¢å¤ä½¿ç”¨ç¡¬ç¼–ç æ˜ å°„è¡¨
        courseInfo: {}, // ä¸å†éœ€è¦courseIdToInfoMap
        cacheInfo: cacheInfo
      }
    });

  } catch (error) {
    console.error('API error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
} 